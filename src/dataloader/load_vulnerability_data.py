import json
import torch
import numpy as np
from torch_geometric.data import Data
from torch_geometric.loader import DataLoader


def load_vulnerability_data(json_path):
    """
    Load vulnerability data from JSON file and convert to PyTorch Geometric format.
    
    Args:
        json_path: Path to JSON file containing vulnerability data
        
    Returns:
        List of Data objects
    """
    with open(json_path, 'r') as f:
        data_list = json.load(f)
    
    dataset = []
    for item in data_list:
        # Extract data
        node_features = torch.tensor(item['node_features'], dtype=torch.float32)
        graph_edges = item['graph']  # List of [source, edge_type, target]
        target = int(item['targets'])
        
        # Convert graph edges to edge_index format [2, E]
        if len(graph_edges) > 0:
            edge_list = torch.tensor(graph_edges, dtype=torch.long)
            edge_index = edge_list[:, [0, 2]].t().contiguous()  # [2, E] format
        else:
            # Empty graph - create self-loops for all nodes
            num_nodes = len(node_features)
            edge_index = torch.arange(num_nodes, dtype=torch.long).repeat(2, 1)
        
        # Create PyTorch Geometric Data object
        data = Data(x=node_features, edge_index=edge_index, y=torch.tensor([target], dtype=torch.long))
        dataset.append(data)
    
    return dataset


def get_dataloaders(train_path, valid_path, test_path=None, batch_size=32, train_ratio=0.8, val_ratio=0.1, test_ratio=0.1):
    """
    Create train, validation, and test dataloaders.
    
    Args:
        train_path: Path to training JSON file (use entire dataset for training)
        valid_path: Path to validation JSON file (use for validation/testing)
        test_path: Optional path to test JSON file (if provided, use for final testing)
        batch_size: Batch size for dataloaders
        train_ratio: Not used (kept for compatibility)
        val_ratio: Not used (kept for compatibility)
        test_ratio: Not used (kept for compatibility)
        
    Returns:
        train_loader, val_loader, test_loader
    """
    # Load training data - use entire train.json for training
    train_data = load_vulnerability_data(train_path)
    
    # Load validation data - use valid.json for validation/testing
    val_data = load_vulnerability_data(valid_path)
    
    if test_path:
        # If separate test file is provided, use it for final testing
        test_data = load_vulnerability_data(test_path)
    else:
        # Otherwise, use valid.json for both validation during training and final testing
        test_data = val_data
    
    # Create dataloaders
    train_loader = DataLoader(train_data, batch_size=batch_size, shuffle=True)
    val_loader = DataLoader(val_data, batch_size=batch_size, shuffle=False)
    test_loader = DataLoader(test_data, batch_size=batch_size, shuffle=False)
    
    return train_loader, val_loader, test_loader

